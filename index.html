<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Scanner v16 - Industriel</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<script src="https://unpkg.com/@zxing/browser@latest"></script>

<style>
:root { --primary:#2563eb; --success:#10b981; --bg:#0f172a; }
body {
  margin:0; font-family:system-ui,sans-serif;
  background:var(--bg); color:white;
  display:flex; flex-direction:column; height:100dvh;
}
.header { background:#1e293b; padding:10px; display:flex; justify-content:space-between; }
#videoWrap { position:relative; height:35%; background:black; }
video { width:100%; height:100%; object-fit:cover; }
.overlay { position:absolute; inset:0; border:25px solid rgba(0,0,0,.55); box-sizing:border-box; pointer-events:none; }
.box { width:160px; height:160px; border:2px solid var(--success); margin:auto; margin-top:12%; }

.status { background:white; color:#0f172a; padding:10px; text-align:center; }
.step { font-size:.7rem; font-weight:bold; color:var(--primary); }
.res { font-weight:800; font-size:1rem; min-height:30px; }

.list { flex:1; overflow:auto; background:#f1f5f9; color:#0f172a; padding:10px; }
.item { background:white; padding:8px; border-radius:8px; margin-bottom:6px; font-size:.8rem; border-left:4px solid var(--primary); }

.footer { background:white; padding:10px; display:grid; gap:8px; grid-template-columns:1fr 1fr; }
button { padding:14px; border:none; border-radius:10px; font-weight:800; }
.start { background:var(--primary); color:white; grid-column:span 2; }
.next { background:var(--success); color:white; grid-column:span 2; }
.csv { background:#e2e8f0; }
.clear { background:#fee2e2; color:#ef4444; }
</style>
</head>

<body>

<div class="header">
  <b id="pName">Panneau 1</b>
  <button onclick="renameP()">Nommer</button>
</div>

<div id="videoWrap">
  <video id="video" playsinline muted></video>
  <div class="overlay"><div class="box"></div></div>
</div>

<div class="status">
  <div id="step" class="step">1. SCANNER LE SN</div>
  <div id="res" class="res">Appuyez sur DÉMARRER</div>
</div>

<div id="list" class="list"></div>

<div class="footer">
  <button class="start" onclick="startCam()">DÉMARRER LE SCAN</button>
  <button class="next" onclick="nextPanel()">＋ PANNEAU SUIVANT</button>
  <button class="csv" onclick="exportCSV()">CSV</button>
  <button class="clear" onclick="clearAll()">VIDER</button>
</div>

<script>
const video = document.getElementById('video');
const stepTxt = document.getElementById('step');
const resTxt = document.getElementById('res');
const listDiv = document.getElementById('list');

const reader = new ZXing.BrowserQRCodeReader();
let scanning = false;

let data = JSON.parse(localStorage.getItem('scan_v16')) || {};
let curPanel = "Panneau 1";
let curSN = "";

render();

async function startCam() {
  const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
  video.srcObject = stream;
  await video.play();
  scanning = true;
  scanLoop();
  resTxt.textContent = "Scan automatique actif";
}

async function scanLoop() {
  if (!scanning) return;
  try {
    const r = await reader.decodeOnceFromVideoElement(video);
    if (r?.text) handleCode(r.text.trim());
  } catch {}
  setTimeout(scanLoop, 300);
}

function handleCode(val) {
  if (!curSN) {
    curSN = val;
    stepTxt.textContent = "2. SCANNER LE MAC";
    resTxt.innerHTML = `SN : <span style="color:#2563eb">${val}</span>`;
  } else {
    if (val === curSN) return;
    save(curPanel, curSN, val);
    curSN = "";
    stepTxt.textContent = "1. SCANNER LE SN";
    resTxt.innerHTML = `<span style="color:#10b981">✅ ENREGISTRÉ</span>`;
    setTimeout(()=>resTxt.textContent="Prêt pour le suivant",1200);
  }
}

function save(p,s,m){
  if(!data[p]) data[p]=[];
  data[p].push({s,m,t:new Date().toLocaleTimeString()});
  localStorage.setItem('scan_v16',JSON.stringify(data));
  render();
}

function render(){
  listDiv.innerHTML="";
  Object.keys(data).reverse().forEach(p=>{
    data[p].forEach((it,i)=>{
      const d=document.createElement('div');
      d.className='item';
      d.innerHTML=`<b>${p}</b><br>SN:${it.s}<br>MAC:${it.m}`;
      listDiv.appendChild(d);
    });
  });
}

function nextPanel(){
  curPanel="Panneau "+(Object.keys(data).length+1);
  document.getElementById('pName').textContent=curPanel;
}

function renameP(){
  const n=prompt("Nom du panneau",curPanel);
  if(n){curPanel=n;document.getElementById('pName').textContent=n;}
}

function exportCSV(){
  let c="Panneau,SN,MAC\n";
  for(const p in data) data[p].forEach(it=>c+=`${p},${it.s},${it.m}\n`);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([c],{type:'text/csv'}));
  a.download="inventaire.csv"; a.click();
}

function clearAll(){
  if(confirm("Tout effacer ?")){
    data={}; localStorage.removeItem('scan_v16'); render();
  }
}
</script>
</body>
</html>
