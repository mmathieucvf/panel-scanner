<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Scanner v15 - S23 Ultra-Net</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root { --primary: #2563eb; --success: #10b981; --bg: #0f172a; }
    body { 
      font-family: system-ui, sans-serif; margin: 0; background: var(--bg); color: white;
      display: flex; flex-direction: column; height: 100dvh; overflow: hidden; 
    }
    .header { padding: 12px; background: #1e293b; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    
    /* Zone VidÃ©o avec viseur amÃ©liorÃ© */
    #video-wrapper { position: relative; width: 100%; height: 35%; background: #000; flex-shrink: 0; overflow: hidden; }
    video { width: 100%; height: 100%; object-fit: cover; }
    .overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      border: 30px solid rgba(0,0,0,0.5); box-sizing: border-box; pointer-events: none;
    }
    .scanner-box { width: 150px; height: 150px; border: 2px solid var(--success); border-radius: 8px; position: relative; }

    /* Barre d'outils Hardware */
    .hw-bar { background: #1e293b; padding: 10px; display: flex; gap: 10px; flex-shrink: 0; }
    .hw-bar button { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #334155; color: white; font-weight: bold; font-size: 0.7rem; }
    .zoom-ctrl { flex: 2; height: 30px; }

    /* Status et RÃ©sultat */
    .status-panel { background: white; color: var(--bg); padding: 10px; text-align: center; flex-shrink: 0; }
    .step-tag { font-size: 0.7rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
    .res-val { font-weight: 800; font-size: 1rem; min-height: 30px; word-break: break-all; }

    /* Liste */
    .list-view { flex: 1; overflow-y: auto; padding: 10px; background: #f1f5f9; color: var(--bg); }
    .item-card { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 5px solid var(--primary); font-size: 0.8rem; }

    /* Pied de page et Gros bouton de scan */
    .footer { padding: 10px; background: white; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; flex-shrink: 0; }
    .btn-capture { background: var(--primary); color: white; padding: 16px; border-radius: 12px; border: none; font-weight: 900; font-size: 1.1rem; grid-column: span 2; }
    .btn-panel { background: var(--success); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; grid-column: span 2; }
  </style>
</head>
<body>

  <div class="header">
    <div id="p-display"><b>Panneau 1</b></div>
    <button onclick="renameP()" style="background:#334155; color:white; border:none; padding:4px 10px; border-radius:4px; font-size:0.6rem;">NOMMER</button>
  </div>

  <div id="video-wrapper">
    <video id="video" playsinline autoplay muted></video>
    <div class="overlay"><div class="scanner-box"></div></div>
  </div>

  <div class="hw-bar">
    <button onclick="toggleT()">ðŸ’¡ TORCHE</button>
    <button onclick="doF()">ðŸŽ¯ FOCUS</button>
    <input type="range" id="zRange" min="1" max="8" step="0.1" value="1" class="zoom-ctrl">
  </div>

  <div class="status-panel">
    <div id="step-txt" class="step-tag">1. SCANNER LE SN</div>
    <div id="res-txt" class="res-val">Appuyez sur "DÃ‰MARRER"</div>
  </div>

  <div class="list-view" id="list"></div>

  <div class="footer">
    <button id="startBtn" onclick="initCam()" class="btn-capture">DÃ‰MARRER LA CAMÃ‰RA</button>
    <button id="scanBtn" onclick="takeSnapshot()" class="btn-capture" style="display:none;">PRENDRE LA PHOTO (SCAN)</button>
    <button onclick="nextP()" class="btn-panel">ï¼‹ PANNEAU SUIVANT</button>
    <button onclick="exportCSV()" style="background:#e2e8f0; border:none; padding:10px; border-radius:8px;">CSV</button>
    <button onclick="clearAll()" style="background:#fee2e2; color:#ef4444; border:none; padding:10px; border-radius:8px;">VIDER</button>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const listDiv = document.getElementById('list');
  const resTxt = document.getElementById('res-txt');
  const stepTxt = document.getElementById('step-txt');
  const ctx = canvas.getContext('2d', { alpha: false });

  let data = JSON.parse(localStorage.getItem('scan_v15')) || {};
  let curP = "Panneau 1";
  let curSN = "";
  let track = null;

  render();

  async function initCam() {
    try {
      const s = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } 
      });
      video.srcObject = s;
      track = s.getVideoTracks()[0];
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('scanBtn').style.display = 'block';
      resTxt.textContent = "Visez le code et cliquez sur le bouton bleu";
    } catch(e) { alert("Erreur d'accÃ¨s camÃ©ra."); }
  }

  function takeSnapshot() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      // Capture haute rÃ©solution
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imgData.data, imgData.width, imgData.height);
      
      if (code) {
        handleCode(code.data);
      } else {
        resTxt.innerHTML = "<span style='color:red;'>Non dÃ©tectÃ©. Essayez de zoomer ou d'Ã©loigner.</span>";
        if (navigator.vibrate) navigator.vibrate(50);
      }
    }
  }

  function handleCode(val) {
    if (navigator.vibrate) navigator.vibrate(100);
    if (!curSN) {
      curSN = val;
      stepTxt.textContent = "2. SCANNER LE MAC";
      resTxt.innerHTML = `SN : <span style="color:#2563eb;">${val}</span>`;
    } else {
      if (val === curSN) {
        resTxt.innerHTML = "<span style='color:orange;'>MÃªme code dÃ©tectÃ©. Visez le MAC.</span>";
        return;
      }
      save(curP, curSN, val);
      curSN = "";
      resTxt.innerHTML = `<span style="color:#10b981;">âœ… ENREGISTRÃ‰</span>`;
      setTimeout(() => {
        stepTxt.textContent = "1. SCANNER LE SN";
        resTxt.textContent = "PrÃªt pour le suivant";
      }, 1500);
    }
  }

  function save(p, s, m) {
    if (!data[p]) data[p] = [];
    data[p].push({ s, m, t: new Date().toLocaleTimeString() });
    localStorage.setItem('scan_v15', JSON.stringify(data));
    render();
  }

  function render() {
    listDiv.innerHTML = "";
    Object.keys(data).reverse().forEach(p => {
      data[p].forEach((it, i) => {
        const d = document.createElement('div');
        d.className = 'item-card';
        d.innerHTML = `<b>${p}</b> | SN: ${it.s}<br>MAC: ${it.m} 
                       <button onclick="del('${p}',${i})" style="float:right; color:red; border:none; background:none; font-weight:bold;">X</button>`;
        listDiv.appendChild(d);
      });
    });
  }

  // Fonctions S23
  async function toggleT() { if(track) { const s = track.getSettings(); await track.applyConstraints({ advanced: [{ torch: !s.torch }] }); } }
  async function doF() { if(track) await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] }); }
  document.getElementById('zRange').oninput = async (e) => {
    const v = parseFloat(e.target.value);
    if(track) { try { await track.applyConstraints({ advanced: [{ zoom: v }] }); } catch { video.style.transform = `scale(${v})`; } }
  };

  function del(p, i) { if(confirm("Supprimer ?")) { data[p].splice(i,1); if(!data[p].length) delete data[p]; localStorage.setItem('scan_v15', JSON.stringify(data)); render(); } }
  function nextP() { curP = "Panneau " + (Object.keys(data).length + 1); document.getElementById('p-display').innerHTML = `<b>${curP}</b>`; }
  function renameP() { const n = prompt("Nom:", curP); if(n) { curP = n; document.getElementById('p-display').innerHTML = `<b>${n}</b>`; } }
  function exportCSV() { 
    let c = "Panneau,SN,MAC\n"; 
    for(const p in data) data[p].forEach(it => c += `${p},${it.s},${it.m}\n`);
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c], {type:'text/csv'})); a.download = "inventaire.csv"; a.click();
  }
  function clearAll() { if(confirm("Vider tout ?")) { data={}; localStorage.removeItem('scan_v15'); render(); } }
</script>
</body>
</html>
