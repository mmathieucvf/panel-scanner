<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Scanner v13 - S23 Fix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    /* Correction pour l'affichage coupÃ© sur mobile */
    :root { --vh: 1vh; }
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      margin: 0; background: #0f172a; color: white;
      display: flex; flex-direction: column;
      height: 100dvh; /* Utilise la hauteur dynamique rÃ©elle */
      overflow: hidden; 
    }

    /* Header compact */
    .header { padding: 10px 15px; background: #1e293b; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    
    /* Zone CamÃ©ra Flexible */
    #video-wrapper { position: relative; width: 100%; height: 35%; background: #000; flex-shrink: 0; border-bottom: 2px solid #3b82f6; }
    video { width: 100%; height: 100%; object-fit: cover; }

    /* ContrÃ´les Hardware */
    .controls-bar { background: #1e293b; padding: 10px; display: flex; gap: 10px; flex-shrink: 0; }
    .controls-bar button { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #334155; color: white; font-weight: bold; font-size: 0.75rem; }
    .zoom-slider { flex: 2; }

    /* Ã‰tat du Scan */
    .status-area { background: white; color: #1e293b; padding: 12px; text-align: center; flex-shrink: 0; }
    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; margin-bottom: 5px; }
    .res-text { font-weight: 800; font-size: 1.1rem; min-height: 24px; word-break: break-all; }

    /* Liste d'inventaire dÃ©filante */
    .list-area { flex: 1; overflow-y: auto; padding: 10px; background: #f1f5f9; color: #1e293b; }
    .card { background: white; padding: 12px; border-radius: 10px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 5px solid #3b82f6; }

    /* Footer Boutons */
    .footer { padding: 12px; background: white; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex-shrink: 0; padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
    .btn { padding: 14px; border-radius: 8px; border: none; font-weight: bold; font-size: 0.9rem; cursor: pointer; }
    .btn-blue { background: #2563eb; color: white; grid-column: span 2; }
    .btn-green { background: #10b981; color: white; grid-column: span 2; }
  </style>
</head>
<body>

  <div class="header">
    <div id="panel-display"><b>Panneau 1</b></div>
    <div style="font-size: 0.6rem; opacity: 0.7;">VERSION 13.0</div>
  </div>

  <div id="video-wrapper">
    <video id="video" playsinline autoplay muted></video>
  </div>

  <div class="controls-bar">
    <button onclick="handleTorch()">ðŸ’¡ TORCHE</button>
    <button onclick="handleFocus()">ðŸŽ¯ FOCUS</button>
    <input type="range" id="zoom" min="1" max="5" step="0.1" value="1" class="zoom-slider">
  </div>

  <div class="status-area">
    <div id="step-label" class="badge" style="background:#dbeafe; color:#1e40af;">ATTENTE SN</div>
    <div id="result-label" class="res-text">PrÃªt Ã  scanner</div>
  </div>

  <div class="list-area" id="inventory"></div>

  <div class="footer">
    <button id="startBtn" class="btn btn-blue">ACTIVER LA CAMÃ‰RA</button>
    <button onclick="createNewPanel()" class="btn btn-green">ï¼‹ NOUVEAU PANNEAU</button>
    <button onclick="exportData()" style="background:#e2e8f0;">CSV</button>
    <button onclick="clearData()" style="background:#fee2e2; color:#ef4444;">VIDER</button>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const invDiv = document.getElementById('inventory');
  const stepLabel = document.getElementById('step-label');
  const resLabel = document.getElementById('result-label');
  const ctx = canvas.getContext('2d', { alpha: false });

  let scanData = JSON.parse(localStorage.getItem('scan_v13')) || {};
  let curPanel = "Panneau 1";
  let curSN = "";
  let active = false;
  let track = null;

  render();

  document.getElementById('startBtn').onclick = async () => {
    // Stop toute session prÃ©cÃ©dente
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(t => t.stop());
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
      });
      video.srcObject = stream;
      track = stream.getVideoTracks()[0];
      active = true;
      document.getElementById('startBtn').style.display = 'none';
      requestAnimationFrame(tick);
    } catch(e) {
      alert("Erreur CamÃ©ra : Assurez-vous d'avoir autorisÃ© l'accÃ¨s et d'Ãªtre en HTTPS.");
    }
  };

  function tick() {
    if (video.readyState === video.HAVE_ENOUGH_DATA && active) {
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
      if (code) {
        onDetected(code.data);
        active = false;
        setTimeout(() => { active = true; }, 2000);
      }
    }
    requestAnimationFrame(tick);
  }

  function onDetected(val) {
    if (navigator.vibrate) navigator.vibrate(100);
    if (!curSN) {
      curSN = val;
      stepLabel.textContent = "ATTENTE MAC";
      stepLabel.style.background = "#fef3c7"; stepLabel.style.color = "#92400e";
      resLabel.innerHTML = `SN: <span style="color:#2563eb;">${val}</span>`;
    } else {
      if (val === curSN) return;
      saveEntry(curPanel, curSN, val);
      curSN = "";
      resLabel.innerHTML = `<span style="color:#10b981;">âœ… AJOUTÃ‰</span>`;
      setTimeout(() => {
        stepLabel.textContent = "ATTENTE SN";
        stepLabel.style.background = "#dbeafe"; stepLabel.style.color = "#1e40af";
        resLabel.textContent = "Suivant...";
      }, 1500);
    }
  }

  function saveEntry(p, s, m) {
    if (!scanData[p]) scanData[p] = [];
    scanData[p].push({ s, m, t: new Date().toLocaleTimeString() });
    localStorage.setItem('scan_v13', JSON.stringify(scanData));
    render();
  }

  function render() {
    invDiv.innerHTML = "";
    Object.keys(scanData).reverse().forEach(p => {
      scanData[p].forEach((item, i) => {
        const d = document.createElement('div');
        d.className = 'card';
        d.innerHTML = `<b>${p}</b> | SN: ${item.s}<br>MAC: ${item.m} 
                       <button onclick="removeItem('${p}',${i})" style="float:right; color:red; border:none; background:none; font-weight:bold;">X</button>`;
        invDiv.appendChild(d);
      });
    });
  }

  // Fonctions Hardware S23
  async function handleTorch() {
    if (track) {
      const s = track.getSettings();
      await track.applyConstraints({ advanced: [{ torch: !s.torch }] });
    }
  }
  async function handleFocus() { if(track) await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] }); }
  document.getElementById('zoom').oninput = async (e) => {
    const v = parseFloat(e.target.value);
    if(track) { try { await track.applyConstraints({ advanced: [{ zoom: v }] }); } catch { video.style.transform = `scale(${v})`; } }
  };

  function removeItem(p, i) { if(confirm("Supprimer ?")) { scanData[p].splice(i,1); if(!scanData[p].length) delete scanData[p]; localStorage.setItem('scan_v13', JSON.stringify(scanData)); render(); } }
  function createNewPanel() { const n = prompt("Nom du panneau:", "Panneau " + (Object.keys(scanData).length + 1)); if(n) { curPanel = n; document.getElementById('panel-display').innerHTML = `<b>${n}</b>`; } }
  function exportData() { 
    let csv = "Panneau,SN,MAC\n"; 
    for(const p in scanData) scanData[p].forEach(it => csv += `${p},${it.s},${it.m}\n`);
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = "inventaire.csv"; a.click();
  }
  function clearData() { if(confirm("Vider ?")) { scanData={}; localStorage.removeItem('scan_v13'); render(); } }
</script>
</body>
</html>
