<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Scanner v8 - Full Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f3f4f6; color: #1f2937; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    
    /* Header & Panel Info */
    .header { padding: 10px 15px; background: #111827; color: white; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    
    /* Camera Zone */
    #video-container { position: relative; width: 100%; height: 200px; background: #000; flex-shrink: 0; overflow: hidden; }
    video { width: 100%; height: 100%; object-fit: cover; }
    
    /* Hardware Controls (Zoom, Torch, Focus) */
    .hw-controls { background: #1f2937; padding: 10px; display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
    .hw-controls button { flex: 1; padding: 10px; font-size: 0.75rem; background: #374151; color: white; border: 1px solid #4b5563; border-radius: 6px; }
    .zoom-slider { flex: 2; height: 30px; }

    /* Scan Status */
    .scanner-ui { padding: 10px; background: white; text-align: center; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; }
    .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; }
    .status-sn { background: #dbeafe; color: #1e40af; }
    .status-mac { background: #fef3c7; color: #92400e; }

    /* Inventory List */
    .inventory-list { flex: 1; overflow-y: auto; padding: 12px; }
    .panel-group { margin-bottom: 15px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    .panel-title { background: #f9fafb; font-weight: bold; padding: 8px 12px; font-size: 0.85rem; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; }
    
    table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
    td { padding: 8px 10px; border-top: 1px solid #f3f4f6; }
    .btn-delete { color: #ef4444; border: 1px solid #ef4444; padding: 2px 6px; border-radius: 4px; background: transparent; }

    /* Footer Buttons */
    .footer-actions { padding: 12px; background: white; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; border-top: 1px solid #e5e7eb; flex-shrink: 0; }
    .btn-main { background: #2563eb; color: white; padding: 12px; border-radius: 8px; border: none; font-weight: bold; grid-column: span 2; }
    .btn-panel { background: #10b981; color: white; padding: 10px; border-radius: 8px; border: none; font-weight: bold; grid-column: span 2; margin-bottom: 5px; }
  </style>
</head>
<body>

  <div class="header">
    <div id="current-panel-display" style="font-weight: bold;">Panneau 1</div>
    <button onclick="renamePanel()" style="padding: 5px 10px; font-size: 0.7rem; background: #4b5563; color: white; border: none; border-radius: 4px;">Renommer</button>
  </div>

  <div id="video-container">
    <video id="video" playsinline></video>
  </div>

  <div class="hw-controls" id="hw-ui" style="display:none;">
    <button id="torchBtn">TORCHE OFF</button>
    <button id="refocusBtn">FOCUS</button>
    <input type="range" id="zoomRange" class="zoom-slider" min="1" max="5" step="0.1" value="1">
  </div>

  <div class="scanner-ui">
    <div id="scan-mode" class="status-badge status-sn">ATTENTE SN</div>
    <div id="last-result" style="font-size: 0.75rem; color: #6b7280;">Scannez le SN du contrôleur</div>
  </div>

  <div class="inventory-list" id="inventory"></div>

  <div class="footer-actions">
    <button id="startBtn" class="btn-main">ACTIVER LA CAMÉRA</button>
    <button onclick="nextPanelAuto()" id="nextPanelBtn" class="btn-panel" style="display:none;">＋ NOUVEAU PANNEAU</button>
    <button onclick="exportData()" style="background:#e5e7eb; color:#374151; border:none; border-radius:8px; padding:10px; font-weight:bold;">Exporter</button>
    <button onclick="clearAll()" style="background:#fef2f2; color:#ef4444; border:none; border-radius:8px; padding:10px; font-weight:bold;">Vider</button>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const inventoryDiv = document.getElementById('inventory');
  const scanModeDiv = document.getElementById('scan-mode');
  const lastResultDiv = document.getElementById('last-result');
  const zoomRange = document.getElementById('zoomRange');
  const torchBtn = document.getElementById('torchBtn');
  const refocusBtn = document.getElementById('refocusBtn');
  const ctx = canvas.getContext('2d', { alpha: false });

  let data = JSON.parse(localStorage.getItem('scanner_data')) || {};
  let currentPanel = "Panneau 1";
  let currentSN = "";
  let isScanning = false;
  let videoTrack = null;
  let torchOn = false;

  renderInventory();

  document.getElementById('startBtn').onclick = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } 
      });
      video.srcObject = stream;
      videoTrack = stream.getVideoTracks()[0];
      await video.play();
      
      isScanning = true;
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('nextPanelBtn').style.display = 'block';
      document.getElementById('hw-ui').style.display = 'flex';
      
      // Essayer l'autofocus continu
      const caps = videoTrack.getCapabilities();
      if (caps.focusMode) videoTrack.applyConstraints({ advanced: [{ focusMode: "continuous" }] });

      requestAnimationFrame(tick);
    } catch(e) { alert("Erreur : " + e.message); }
  };

  function tick() {
    if (video.readyState === video.HAVE_ENOUGH_DATA && isScanning) {
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      if (code) {
        processScan(code.data);
        isScanning = false;
        setTimeout(() => { isScanning = true; }, 1800);
      }
    }
    requestAnimationFrame(tick);
  }

  function processScan(val) {
    if (!currentSN) {
      currentSN = val;
      scanModeDiv.textContent = "ATTENTE MAC";
      scanModeDiv.className = "status-badge status-mac";
      lastResultDiv.innerHTML = `SN: <b>${val}</b>. Scannez le MAC.`;
      if (navigator.vibrate) navigator.vibrate(80);
    } else {
      saveEntry(currentPanel, currentSN, val);
      currentSN = "";
      scanModeDiv.textContent = "ATTENTE SN";
      scanModeDiv.className = "status-badge status-sn";
      lastResultDiv.innerHTML = `✅ Ajouté au ${currentPanel}`;
      if (navigator.vibrate([80, 50, 80]));
    }
  }

  // --- HARDWARE CONTROLS ---
  torchBtn.onclick = async () => {
    if (!videoTrack) return;
    torchOn = !torchOn;
    try {
      await videoTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
      torchBtn.textContent = torchOn ? "TORCHE ON" : "TORCHE OFF";
    } catch(e) { alert("Torche non supportée"); }
  };

  refocusBtn.onclick = async () => {
    if (!videoTrack) return;
    try {
      await videoTrack.applyConstraints({ advanced: [{ focusMode: "manual", focusDistance: 0.1 }] });
      setTimeout(() => {
        videoTrack.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
      }, 500);
    } catch(e) { alert("Focus manuel non supporté"); }
  };

  zoomRange.oninput = async () => {
    if (!videoTrack) return;
    const zoomVal = parseFloat(zoomRange.value);
    try {
      await videoTrack.applyConstraints({ advanced: [{ zoom: zoomVal }] });
    } catch(e) {
      video.style.transform = `scale(${zoomVal})`; // Fallback zoom numérique
    }
  };

  // --- LOGIQUE INVENTAIRE ---
  function saveEntry(panel, sn, mac) {
    if (!data[panel]) data[panel] = [];
    data[panel].push({ sn, mac, time: new Date().toLocaleTimeString() });
    localStorage.setItem('scanner_data', JSON.stringify(data));
    renderInventory();
  }

  function nextPanelAuto() {
    const nextNum = Object.keys(data).length + 1;
    currentPanel = "Panneau " + nextNum;
    document.getElementById('current-panel-display').textContent = currentPanel;
    if (!data[currentPanel]) data[currentPanel] = [];
    renderInventory();
  }

  function renamePanel() {
    const name = prompt("Nom du panneau :", currentPanel);
    if (name) {
      if (data[currentPanel]) { data[name] = data[currentPanel]; delete data[currentPanel]; }
      currentPanel = name;
      document.getElementById('current-panel-display').textContent = name;
      localStorage.setItem('scanner_data', JSON.stringify(data));
      renderInventory();
    }
  }

  function deleteRow(panel, idx) {
    if (confirm("Supprimer ?")) {
      data[panel].splice(idx, 1);
      if (data[panel].length === 0) delete data[panel];
      localStorage.setItem('scanner_data', JSON.stringify(data));
      renderInventory();
    }
  }

  function renderInventory() {
    inventoryDiv.innerHTML = "";
    Object.keys(data).reverse().forEach(panel => {
      const section = document.createElement('div'); section.className = 'panel-group';
      let rows = data[panel].map((c, i) => `
        <tr>
          <td>SN: ${c.sn}<br>MAC: ${c.mac}</td>
          <td style="text-align:right;"><button class="btn-delete" onclick="deleteRow('${panel}', ${i})">X</button></td>
        </tr>`).join('');
      section.innerHTML = `
        <div class="panel-title"><span>${panel}</span> <span>${data[panel].length} unités</span></div>
        <table><tbody>${rows}</tbody></table>`;
      inventoryDiv.appendChild(section);
    });
  }

  function exportData() {
    let csv = "Panneau,SN,MAC,Heure\n";
    for (const p in data) data[p].forEach(c => csv += `${p},${c.sn},${c.mac},${c.time}\n`);
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `inventaire_${new Date().toISOString().split('T')[0]}.csv`; a.click();
  }

  function clearAll() {
    if (confirm("Vider TOUT l'inventaire ?")) { data = {}; localStorage.removeItem('scanner_data'); renderInventory(); }
  }
</script>
</body>
</html>
