<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Scanner Pro v4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #000; color: white; display: flex; flex-direction: column; height: 100vh; }
    .header { padding: 15px; background: #111827; text-align: center; font-weight: bold; }
    #video-container { flex: 1; position: relative; overflow: hidden; background: #000; }
    video { width: 100%; height: 100%; object-fit: cover; }
    
    .ui-overlay { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); padding: 20px; box-sizing: border-box; }
    .status { margin-bottom: 15px; font-size: 0.9rem; min-height: 1.2rem; text-align: center; color: #10b981; }
    
    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button { padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
    .btn-primary { background: #2563eb; color: white; grid-column: span 2; }
    .btn-secondary { background: #4b5563; color: white; }
    
    .zoom-slider { margin-top: 15px; width: 100%; }
    label { font-size: 0.8rem; display: block; margin-bottom: 5px; }
  </style>
</head>
<body>

  <div class="header">PANEL SCANNER v4</div>

  <div id="video-container">
    <video id="video" playsinline></video>
  </div>

  <div class="ui-overlay">
    <div id="status" class="status">Prêt</div>
    
    <div class="btn-group">
      <button id="startBtn" class="btn-primary">DÉMARRER LA CAMÉRA</button>
      <button id="torchBtn" class="btn-secondary" style="display:none;">TORCHE OFF</button>
      <button id="refocusBtn" class="btn-secondary" style="display:none;">REFOCUS</button>
    </div>

    <div id="zoom-area" style="display:none;">
      <label>Zoom Matériel :</label>
      <input type="range" id="zoomRange" class="zoom-slider" min="1" max="5" step="0.1" value="1">
    </div>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const status = document.getElementById('status');
  const startBtn = document.getElementById('startBtn');
  const torchBtn = document.getElementById('torchBtn');
  const refocusBtn = document.getElementById('refocusBtn');
  const zoomRange = document.getElementById('zoomRange');
  const ctx = canvas.getContext('2d', { alpha: false });

  let videoTrack = null;

  startBtn.onclick = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { 
          facingMode: 'environment',
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      });
      video.srcObject = stream;
      videoTrack = stream.getVideoTracks()[0];
      
      await video.play();
      startBtn.style.display = 'none';
      torchBtn.style.display = 'block';
      refocusBtn.style.display = 'block';
      document.getElementById('zoom-area').style.display = 'block';

      // Tenter d'activer l'autofocus continu
      const capabilities = videoTrack.getCapabilities();
      if (capabilities.focusMode) {
        videoTrack.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
      }

      requestAnimationFrame(tick);
    } catch (err) {
      status.textContent = "Erreur: " + err.message;
    }
  };

  // Bouton pour forcer le focus (sur certains Android)
  refocusBtn.onclick = async () => {
    if (videoTrack) {
      status.textContent = "Mise au point...";
      try {
        await videoTrack.applyConstraints({ advanced: [{ focusMode: "manual", focusDistance: 0.1 }] }); // Focus proche
        setTimeout(() => {
          videoTrack.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
        }, 500);
      } catch (e) { status.textContent = "Focus manuel non supporté"; }
    }
  };

  // Gestion de la lampe torche
  let torchOn = false;
  torchBtn.onclick = async () => {
    if (videoTrack) {
      torchOn = !torchOn;
      try {
        await videoTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
        torchBtn.textContent = torchOn ? "TORCHE ON" : "TORCHE OFF";
      } catch (e) { status.textContent = "Flash non supporté"; }
    }
  };

  // Zoom Matériel
  zoomRange.oninput = async () => {
    if (videoTrack) {
      try {
        await videoTrack.applyConstraints({ advanced: [{ zoom: parseFloat(zoomRange.value) }] });
      } catch (e) {
        // Fallback zoom numérique si le matériel échoue
        video.style.transform = `scale(${zoomRange.value})`;
      }
    }
  };

  function tick() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);

      if (code) {
        status.innerHTML = "✅ TROUVÉ : " + code.data;
        if (navigator.vibrate) navigator.vibrate(200);
      }
    }
    requestAnimationFrame(tick);
  }
</script>
</body>
</html>
