<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Scanner v10 - Fix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f3f4f6; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    .header { padding: 10px; background: #111827; color: white; display: flex; justify-content: space-between; flex-shrink: 0; }
    
    /* Zone VidÃ©o */
    #video-container { width: 100%; height: 200px; background: #000; flex-shrink: 0; position: relative; }
    video { width: 100%; height: 100%; object-fit: cover; }
    
    /* Boutons de contrÃ´le (Visibles par dÃ©faut) */
    .hw-controls { background: #1f2937; padding: 10px; display: flex; gap: 5px; flex-shrink: 0; }
    .hw-controls button { flex: 1; padding: 10px; font-size: 0.7rem; background: #374151; color: white; border: 1px solid #4b5563; border-radius: 4px; }
    .zoom-slider { flex: 2; }

    /* Statut */
    .scanner-ui { padding: 10px; background: white; text-align: center; border-bottom: 2px solid #2563eb; flex-shrink: 0; }
    .result-display { font-weight: bold; font-size: 1rem; min-height: 40px; margin-top: 5px; }

    /* Liste */
    .inventory-list { flex: 1; overflow-y: auto; padding: 10px; }
    .panel-group { margin-bottom: 10px; background: white; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .panel-title { background: #f9fafb; padding: 8px; font-weight: bold; font-size: 0.8rem; display: flex; justify-content: space-between; }
    table { width: 100%; font-size: 0.75rem; border-collapse: collapse; }
    td { padding: 8px; border-top: 1px solid #eee; }

    /* Pied de page */
    .footer { padding: 10px; background: white; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; flex-shrink: 0; }
    .btn-blue { background: #2563eb; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: bold; grid-column: span 2; }
  </style>
</head>
<body>

  <div class="header">
    <span id="current-panel-display" style="font-weight:bold;">Panneau 1</span>
    <button onclick="renamePanel()" style="font-size:0.7rem; background:#4b5563; color:white; border:none; padding:4px 8px;">Renommer</button>
  </div>

  <div id="video-container">
    <video id="video" playsinline autoplay muted></video>
  </div>

  <div class="hw-controls">
    <button id="torchBtn">ðŸ’¡ TORCHE</button>
    <button id="refocusBtn">ðŸŽ¯ FOCUS</button>
    <input type="range" id="zoomRange" class="zoom-slider" min="1" max="5" step="0.1" value="1">
  </div>

  <div class="scanner-ui">
    <div id="scan-mode" style="font-size:0.7rem; font-weight:bold; color:#1e40af;">ATTENTE SN</div>
    <div id="last-result" class="result-display">Appuyez sur "DÃ‰MARRER"</div>
  </div>

  <div class="inventory-list" id="inventory"></div>

  <div class="footer">
    <button id="startBtn" class="btn-blue">DÃ‰MARRER LA CAMÃ‰RA</button>
    <button onclick="nextPanelAuto()" style="background:#10b981; color:white; border:none; padding:10px; border-radius:6px; font-weight:bold; grid-column: span 2;">ï¼‹ NOUVEAU PANNEAU</button>
    <button onclick="exportData()" style="background:#e5e7eb; padding:10px; border:none; border-radius:6px;">Exporter</button>
    <button onclick="clearAll()" style="background:#fef2f2; color:#ef4444; padding:10px; border:none; border-radius:6px;">Vider</button>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const inventoryDiv = document.getElementById('inventory');
  const lastResultDiv = document.getElementById('last-result');
  const ctx = canvas.getContext('2d', { alpha: false });

  let data = JSON.parse(localStorage.getItem('scanner_data')) || {};
  let currentPanel = "Panneau 1";
  let currentSN = "";
  let isScanning = false;
  let videoTrack = null;

  renderInventory();

  document.getElementById('startBtn').onclick = async () => {
    lastResultDiv.textContent = "Lancement camÃ©ra...";
    try {
      // RÃ©solution rÃ©duite pour plus de compatibilitÃ©
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment', width: 1280, height: 720 } 
      });
      video.srcObject = stream;
      videoTrack = stream.getVideoTracks()[0];
      
      // Force la lecture
      video.onloadedmetadata = () => {
        video.play();
        isScanning = true;
        lastResultDiv.textContent = "PrÃªt ! Scannez le SN";
        document.getElementById('startBtn').style.display = 'none';
        requestAnimationFrame(tick);
      };
    } catch(e) {
      lastResultDiv.innerHTML = "<span style='color:red;'>ERREUR: " + e.name + "</span>";
      console.error(e);
    }
  };

  function tick() {
    if (video.readyState === video.HAVE_ENOUGH_DATA && isScanning) {
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      if (code) {
        processScan(code.data);
        isScanning = false;
        setTimeout(() => { isScanning = true; }, 2000);
      }
    }
    requestAnimationFrame(tick);
  }

  function processScan(val) {
    if (!currentSN) {
      currentSN = val;
      document.getElementById('scan-mode').textContent = "ATTENTE MAC";
      lastResultDiv.innerHTML = `SN: <span style="color:blue;">${val}</span><br>Scannez le MAC`;
    } else {
      saveEntry(currentPanel, currentSN, val);
      lastResultDiv.innerHTML = `âœ… AjoutÃ© !<br>PrÃªt pour suivant`;
      currentSN = "";
      document.getElementById('scan-mode').textContent = "ATTENTE SN";
    }
    if (navigator.vibrate) navigator.vibrate(100);
  }

  // Hardware controls
  document.getElementById('torchBtn').onclick = async () => {
    if (videoTrack) {
      const caps = videoTrack.getCapabilities();
      if (caps.torch) {
        const currentTorch = videoTrack.getConstraints().advanced?.[0]?.torch || false;
        await videoTrack.applyConstraints({ advanced: [{ torch: !currentTorch }] });
      } else { alert("Torche non supportÃ©e"); }
    }
  };

  document.getElementById('refocusBtn').onclick = async () => {
    if (videoTrack) {
      await videoTrack.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
    }
  };

  document.getElementById('zoomRange').oninput = async (e) => {
    if (videoTrack) {
      const val = parseFloat(e.target.value);
      try { await videoTrack.applyConstraints({ advanced: [{ zoom: val }] }); }
      catch(e) { video.style.transform = `scale(${val})`; }
    }
  };

  function saveEntry(panel, sn, mac) {
    if (!data[panel]) data[panel] = [];
    data[panel].push({ sn, mac, time: new Date().toLocaleTimeString() });
    localStorage.setItem('scanner_data', JSON.stringify(data));
    renderInventory();
  }

  function renderInventory() {
    inventoryDiv.innerHTML = "";
    Object.keys(data).reverse().forEach(p => {
      const section = document.createElement('div'); section.className = 'panel-group';
      let rows = data[p].map((c, i) => `<tr><td>SN: ${c.sn}<br>MAC: ${c.mac}</td><td style="text-align:right;"><button onclick="deleteRow('${p}',${i})" style="color:red; border:none; background:none;">X</button></td></tr>`).join('');
      section.innerHTML = `<div class="panel-title"><span>${p}</span> <span>${data[p].length}</span></div><table>${rows}</table>`;
      inventoryDiv.appendChild(section);
    });
  }

  function nextPanelAuto() {
    currentPanel = "Panneau " + (Object.keys(data).length + 1);
    document.getElementById('current-panel-display').textContent = currentPanel;
    if (!data[currentPanel]) data[currentPanel] = [];
    renderInventory();
  }

  function deleteRow(p, i) { if (confirm("Supprimer ?")) { data[p].splice(i,1); if(data[p].length==0) delete data[p]; localStorage.setItem('scanner_data', JSON.stringify(data)); renderInventory(); } }
  function renamePanel() { const n = prompt("Nom:", currentPanel); if(n) { if(data[currentPanel]) { data[n]=data[currentPanel]; delete data[currentPanel]; } currentPanel=n; document.getElementById('current-panel-display').textContent=n; localStorage.setItem('scanner_data', JSON.stringify(data)); renderInventory(); } }
  function exportData() { let csv = "Panneau,SN,MAC\n"; for(const p in data) data[p].forEach(c => csv += `${p},${c.sn},${c.mac}\n`); const blob = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`export.csv`; a.click(); }
  function clearAll() { if(confirm("Tout effacer ?")) { data={}; localStorage.removeItem('scanner_data'); renderInventory(); } }
</script>
</body>
</html>
